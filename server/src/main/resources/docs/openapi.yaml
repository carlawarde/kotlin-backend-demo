openapi: 3.0.0
info:
  title: Kotlin Backend Demo API
  description: API for user registration, login sessions and video game logging/review
  version: 1.0.0
  contact:
    name: Carla Warde
    url: https://github.com/carlawarde/kotlin-backend-demo

servers:
  - url: http://localhost:8080
    description: Development server

tags:
  - name: User
    description: User functionality such as registering, login
  - name: Health
    description: Application health checks and status
  - name: Observability
    description: Metrics and monitoring endpoints

paths:
  /register:
    post:
      summary: Register a new user account
      operationId: registerUser
      tags:
        - User
      description: |
        Creates a new user account with the provided credentials.
        
        **Validation Rules:**
        - Username: 3-30 characters, alphanumeric with periods, hyphens, underscores
        - Email: Valid email format (user@domain.com)
        - Password: Min 8 chars, must contain uppercase, lowercase, number, and special char (@$!%*?&)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PostRegisterUserRequest'
            examples:
              success:
                summary: Valid registration
                value:
                  username: john_doe
                  email: john@example.com
                  password: SecurePass123!
      responses:
        '201':
          description: User successfully created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PostRegisterUserResponse'
              example:
                id: 123e4567-e89b-12d3-a456-426614174000
                username: john_doe
                email: john@example.com
        '400':
          description: Validation error or business rule violation
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/ValidationErrorResponse'
                  - $ref: '#/components/schemas/ErrorResponse'
              examples:
                validation_error:
                  summary: Field validation errors
                  value:
                    internalCode: VAL_001
                    message: User input did not meet requirements. Please resolve the following issues to proceed.
                    fields:
                      username:
                        - must have at least 3 characters
                      password:
                        - must contain at least one lowercase letter, one uppercase letter, one number and one special character
                duplicate_email:
                  summary: Email already registered
                  value:
                    internalCode: USR_001
                    message: There is already an account with this email.
                duplicate_username:
                  summary: Username already taken
                  value:
                    internalCode: USR_002
                    message: There is already an account with this username.
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /health/live:
    get:
      summary: Liveness probe
      operationId: getLiveness
      tags:
        - Health
      description: |
        Kubernetes liveness probe endpoint. Indicates if the application is running.
        Used for container orchestration to determine if the pod should be restarted.
      responses:
        '200':
          description: Application is alive
          content:
            text/plain:
              schema:
                type: string
              example: OK
        '503':
          description: Application is not responding
          content:
            text/plain:
              schema:
                type: string
              example: NOT OK

  /health/ready:
    get:
      summary: Readiness probe
      operationId: getReadiness
      tags:
        - Health
      description: |
        Kubernetes readiness probe endpoint. Indicates if the application can handle traffic.
        Checks if critical dependencies (database) are available.
      responses:
        '200':
          description: Application is ready to serve traffic
          content:
            text/plain:
              schema:
                type: string
              example: READY
        '503':
          description: Application is not ready (dependencies unavailable)
          content:
            text/plain:
              schema:
                type: string
              example: NOT READY

  /health/status:
    get:
      summary: Get application status
      operationId: getStatus
      tags:
        - Health
      description: Returns current application state (RUNNING, DRAINING, STOPPED, etc)
      responses:
        '200':
          description: Current application state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusResponse'

  /metrics:
    get:
      summary: Prometheus metrics endpoint
      operationId: getMetrics
      tags:
        - Observability
      description: |
        Prometheus-compatible metrics endpoint. Returns metrics in OpenMetrics format.
        
        Includes:
        - API request duration and counts by operation
        - Application health metrics
        - JVM metrics
      responses:
        '200':
          description: Metrics in OpenMetrics format
          content:
            text/plain:
              schema:
                type: string
              example: |
                # HELP api_http_request_duration_seconds Duration of API requests
                # TYPE api_http_request_duration_seconds summary
                api_http_request_duration_seconds_sum{api="users",action="create",outcome="success"} 1.234

components:
  schemas:
    PostRegisterUserRequest:
      type: object
      description: User registration request payload
      required:
        - username
        - email
        - password
      properties:
        username:
          type: string
          minLength: 3
          maxLength: 30
          pattern: ^[a-zA-Z0-9_\-.]*$
          description: Username for the account (alphanumeric, periods, hyphens, underscores)
          example: john_doe
        email:
          type: string
          format: email
          description: Email address for the account
          example: john@example.com
        password:
          type: string
          minLength: 8
          format: password
          description: |
            Password must contain:
            - At least one lowercase letter
            - At least one uppercase letter
            - At least one number
            - At least one special character (@$!%*?&)
          example: SecurePass123!

    PostRegisterUserResponse:
      type: object
      description: Successful user registration response
      required:
        - id
        - username
        - email
      properties:
        id:
          type: string
          format: uuid
          description: Unique user ID
          example: 123e4567-e89b-12d3-a456-426614174000
        username:
          type: string
          description: The registered username
          example: john_doe
        email:
          type: string
          format: email
          description: The registered email address
          example: john@example.com

    StatusResponse:
      type: object
      description: Application status information
      required:
        - status
        - timestamp
      properties:
        status:
          type: string
          enum: [RUNNING, DRAINING, STOPPED]
          description: Current application state
          example: RUNNING
        timestamp:
          type: string
          format: date-time
          description: When the status was recorded
          example: 2026-02-10T15:30:00Z

    ErrorResponse:
      type: object
      description: Standard error response for all errors
      required:
        - internalCode
        - message
      properties:
        internalCode:
          type: string
          description: |
            Internal error code for tracking and support.
            Format: CATEGORY_NUMBER (e.g., USR_001, VAL_001)
          example: USR_001
        message:
          type: string
          description: User-friendly error message (safe to display to client)
          example: There is already an account with this email.

    ValidationErrorResponse:
      type: object
      description: Error response with field-level validation details
      required:
        - internalCode
        - message
        - fields
      properties:
        internalCode:
          type: string
          description: Validation error code (always VAL_001)
          example: VAL_001
        message:
          type: string
          description: General validation error message
          example: User input did not meet requirements. Please resolve the following issues to proceed.
        fields:
          type: object
          description: Map of field names to list of validation error messages
          additionalProperties:
            type: array
            items:
              type: string
          example:
            username:
              - must have at least 3 characters
            password:
              - must contain at least one lowercase letter, one uppercase letter, one number and one special character